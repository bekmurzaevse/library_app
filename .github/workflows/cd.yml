name: Deploy

on:
  push:
    branches:
      - main

jobs:
  # deploy:
  #   runs-on: ubuntu:latest

  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v2

  #     - name: Deploy to server
  #       uses: appleboy/ssh-action@master
  #       with:
  #         host: ${{ secrets.VPS_HOST }}
  #         username: ${{ secrets.VPS_USER }}
  #         key: ${{ secrets.VPS_KEY }}
  #         script: |
  #           cd /home/${{ secrets.VPS_USER }}
  #           echo "Pulling latest changes..."
  #           git pull origin main

  #           echo "Building docker containers..."
  #           docker compose down
  #           docker compose up -d --build

  #           echo "Running Laravel commands..."
  #           docker exec project_php composer install --no-interaction --prefer-dist
  #           docker exec project_php php artisan migrate --force
  #           docker exec project_php php artisan config:cache

  # test1111
  deploy:
    name: üöÄ Deploy to Server
    # needs: laravel-tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ SSH-–∫–ª—é—á–∞
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: üì§ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          ssh -o StrictHostKeyChecking=no saylaww@176.96.243.188 << 'EOF'
            cd /home/saylaww/library
            git config --global --add safe.directory /home/saylaww/library
            git pull origin ${GITHUB_REF_NAME}
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d --build
            docker exec project_php php artisan migrate --force
            docker exec project_php php artisan config:cache
            docker exec project_php php artisan l5-swagger:generate
          EOF

      - name: üß™ SQLite bilan testlar
        run: |
          php artisan config:clear
          php artisan test
